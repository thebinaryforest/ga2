{% extends 'base.html' %}

{% block title %}Home - GA2{% endblock %}

{% block content %}
<h1>GBIF Alert</h1>

{% if user.is_authenticated %}
<p>Welcome, <strong>{{ user.username }}</strong>!</p>

<h2>Your Alerts</h2>
{% if user_alerts %}
<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
    <thead>
        <tr style="background: #f0f0f0; text-align: left;">
            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Name</th>
            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Species</th>
            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Datasets</th>
            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Email</th>
            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Unseen</th>
        </tr>
    </thead>
    <tbody>
        {% for alert in user_alerts %}
        <tr>
            <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong><a href="{% url 'admin:alerts_alert_change' alert.pk %}">{{ alert.name }}</a></strong></td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">
                {% if alert.species.all %}
                    {% for sp in alert.species.all %}{{ sp.scientific_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                {% else %}
                    <em>All</em>
                {% endif %}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">
                {% if alert.datasets.all %}
                    {% for ds in alert.datasets.all %}{{ ds.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                {% else %}
                    <em>All</em>
                {% endif %}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ alert.get_email_frequency_display }}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">
                {% if alert.unseen_count > 0 %}
                    <strong style="color: #d9534f;">{{ alert.unseen_count }}</strong>
                {% else %}
                    0
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p><em>You have no alerts yet. Create one in the <a href="{% url 'admin:alerts_alert_add' %}">admin</a>.</em></p>
{% endif %}

{% else %}
<p>GA2 helps you track biodiversity observations from GBIF.</p>
<p><a href="{% url 'login' %}" class="btn">Login</a> to manage your alerts.</p>
{% endif %}
<hr style="margin: 30px 0;">

<h2>Observation Statistics</h2>
<p><strong>Total observations:</strong> {{ total_count|default:"0" }}</p>

{% if species_counts %}
<h3>By Species (sample)</h3>
<ul>
    {% for item in species_counts %}
    <li>{{ item.species.scientific_name }}: {{ item.count }}</li>
    {% endfor %}
</ul>
{% endif %}

{% if dataset_counts %}
<h3>By Dataset (sample)</h3>
<ul>
    {% for item in dataset_counts %}
    <li>{{ item.dataset.name }}: {{ item.count }}</li>
    {% endfor %}
</ul>
{% endif %}

{% if combined_count is not None %}
<h3>Combined Filter (species AND dataset)</h3>
<p>Observations matching any of the {{ sample_species|length }} species above AND any of the {{ sample_datasets|length }} datasets above: <strong>{{ combined_count }}</strong></p>
{% endif %}

{% if not species_counts and not dataset_counts %}
<p><em>No observations in the system yet.</em></p>
{% endif %}
{% endblock %}
